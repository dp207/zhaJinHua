<view class="container">
  <!-- 复制成功提示 -->
  <view class="copy-toast {{showCopyToast ? 'show-toast' : ''}}">
    <text>房间号复制成功</text>
  </view>
  <!-- 房间信息 -->
  <view class="room-info">
    <view class="room-id-container">
      <text class="room-id-label">房间号:</text>
      <text class="room-id-value" selectable="true">{{roomId}}</text>
      <view class="copy-icon" bindtap="copyRoomId">复制</view>
    </view>
    <view class="base-score-container">
      <text class="base-score-label">底分:</text>
      <text class="base-score-value">{{baseScore}}</text>
    </view>
    <button class="leave-btn" hover-class="leave-btn-hover" bindtap="onLeaveRoom">离开</button>
  </view>

  <!-- 游戏区域 -->
  <view class="game-area">
    <!-- 牌桌 -->
    <view class="poker-table">
      <!-- 游戏状态栏 -->
      <view class="game-status-bar">
        <!-- 下注池 -->
        <view class="pot">
          <text>总下注: {{totalPot}}</text>
        </view>
        <!-- 当前玩家提示 -->
       <!-- <view class="current-player-tip" wx:if="{{gameStatus === 'playing' && gameData.currentPlayerIndex !== undefined && gameData.players && gameData.players[gameData.currentPlayerIndex]}}">
          <text>当前操作: {{gameData.players[gameData.currentPlayerIndex] ? gameData.players[gameData.currentPlayerIndex].nickname : ''}}</text>
        </view>-->
      </view>

      <!-- 玩家区域 -->
      <view class="players-container"> 
        <!-- 其他玩家 - 确保当前玩家不在此区域显示 -->
        <block wx:for="{{players}}" wx:key="openId">
          <view class="player {{item.isDealer ? 'dealer-player' : ''}} {{gameStatus === 'playing' && gameData.currentPlayerIndex !== undefined && gameData.players[gameData.currentPlayerIndex] && gameData.players[gameData.currentPlayerIndex].openId === item.openId ? 'current-active-player' : ''}}" wx:if="{{item.openId !== userInfo._openid}}">
            <!-- 当前玩家头像动画效果通过CSS实现，不需要额外的指示器元素 -->
            <image class="avatar" src="{{item.avatarUrl}}" bindtap="showPlayerInfo" data-player-id="{{item.openId}}"></image>
            <text class="status">{{item.status}}</text>
            <text class="bet" wx:if="{{item.currentBet > 0}}">下注：{{item.currentBet}}</text>
            <text class="dealer-badge" wx:if="{{item.isDealer}}">庄家</text>
            <!-- 玩家手牌 -->
            <view class="hand-cards {{item.hasChecked ? 'has-checked' : ''}}" wx:if="{{item.handCards && item.handCards.length > 0}}">
              <block wx:for="{{item.handCards}}" wx:for-item="card" wx:key="index">
                <view class="card {{card.isVisible ? 'visible' : 'hidden'}}">
                  <text wx:if="{{card.isVisible}}" data-suit="{{card.suit}}">{{card.suit}}{{card.value}}</text>
                </view>
              </block>
            </view>
          </view>
        </block>
      </view>
      
      <!-- 当前玩家牌区域 - 只显示牌，不显示头像和昵称 -->
      <view class="current-player-area" wx:if="{{gameStatus === 'playing'}}">

        <block wx:for="{{players}}" wx:key="openId">
          <block wx:if="{{item.openId === userInfo._openid}}">
            <!-- 当前玩家信息显示在牌上方，不显示昵称 -->
            <view >
              <text class="current-player-score">积分：{{item.score}}</text>
              <text class="current-player-bet" wx:if="{{item.currentBet > 0}}">下注：{{item.currentBet}}</text>
              <text class="current-player-status">{{item.status}}</text>
            </view>
            <!-- 只显示当前玩家的牌，没看牌前显示牌背 -->
            <view class="current-player-cards" wx:if="{{item.handCards && item.handCards.length > 0}}">
              <block wx:for="{{item.handCards}}" wx:for-item="card" wx:key="index">
                <view class="current-player-card {{card.isVisible ? 'visible' : 'hidden'}}">
                  <text wx:if="{{card.isVisible}}" data-suit="{{card.suit}}">{{card.suit}}{{card.value}}</text>
                </view>
              </block>
            </view>
          </block>
        </block>
      </view>
    </view>

  </view>
  
  <!-- 操作区域 - 两行按钮布局 -->
  <view class="action-area" wx:if="{{gameStatus === 'playing'}}">
    <!-- 当前玩家已弃牌，显示准备按钮 -->
    <view class="ready-area" wx:if="{{players[players.length-1].status === 'fold'|| players[players.length-1].status === 'out'}}">
      <button class="ready-btn" bindtap="onPlayerReady">准备</button>
    </view>
    <!-- 当前玩家未弃牌，显示操作按钮 -->
    <block wx:else>
      <view class="action-row">
        <!-- 第一行按钮 -->
        <button class="action-btn" bindtap="onCheck">看牌</button>
        <button class="action-btn" bindtap="onFold">弃牌</button>
        <button class="action-btn" bindtap="onFollow" wx:if="{{isCurrentPlayer}}">跟注</button>
      </view>
      <view class="action-row">
        <!-- 第二行按钮 -->
        <button class="action-btn" bindtap="onRaise" wx:if="{{isCurrentPlayer}}">加注</button>
        <button class="action-btn" bindtap="onCompare" wx:if="{{isCurrentPlayer}}">比牌</button>
      </view>
    </block>
  </view>
  
  <!-- 等待状态下的玩家信息和准备按钮 -->
  <view class="waiting-player-area" wx:if="{{gameStatus === 'waiting'}}">
    <!-- 显示当前玩家积分 -->
    <view class="waiting-player-info">
      <block wx:for="{{players}}" wx:key="openId">
        <block wx:if="{{item.openId === userInfo._openid}}">
          <text class="waiting-player-score">我的积分：{{item.score}}</text>
        </block>
      </block>
    </view>
    <!-- 准备按钮 -->
    <button class="ready-btn" bindtap="onPlayerReady">{{isReady ? '取消准备' : '准备'}}</button>
  </view>

  <!-- 加注输入框 -->
  <view class="raise-input" wx:if="{{showRaiseInput}}">
    <input type="number" placeholder="请输入加注金额" bindinput="onRaiseInputChange" value="{{raiseAmount}}"/>
    <button bindtap="confirmRaise">确定</button>
    <button bindtap="cancelRaise">取消</button>
  </view>

  <!-- 比牌选择 -->
  <view class="compare-select" wx:if="{{showCompareSelect}}">
    <text>选择要比牌的玩家:</text>
    <view class="compare-players">
      <block wx:for="{{activePlayers}}" wx:key="openId">
        <button wx:if="{{item.openId !== userInfo._openid}}" bindtap="confirmCompare" data-player-id="{{item.openId}}">{{item.nickname}}</button>
      </block>
    </view>
    <button bindtap="cancelCompare">取消</button>
  </view>
    
  <!-- 聊天区域 - 右下角侧边栏 -->
  <view class="chat-area-sidebar {{chatCollapsed ? 'collapsed' : ''}}">
    <view class="chat-header" bindtap="toggleChatCollapse">
      <text>{{chatCollapsed ? '聊天' : '收起'}}</text>
    </view>
    <view class="chat-messages" wx:if="{{!chatCollapsed}}">
      <block wx:for="{{chatMessages}}" wx:key="index">
        <view class="chat-message-bubble">
          <image class="chat-avatar" src="{{item.avatarUrl}}"></image>
          <view class="chat-bubble-content">
            <text class="chat-sender">{{item.nickname}}:</text>
            <text class="chat-content">{{item.content}}</text>
          </view>
        </view>
      </block>
    </view>
    <view class="chat-input" wx:if="{{!chatCollapsed}}">
      <input placeholder="输入消息..." bindinput="onChatInputChange" value="{{chatInput}}" maxlength="50"/>
      <button bindtap="sendChatMessage" disabled="{{!canSendChat}}">发送</button>
    </view>
  </view>
  
  <!-- 玩家信息弹出层 -->
  <view class="player-info-popup" wx:if="{{showPlayerInfoPopup}}">
    <view class="player-info-content">
      <image class="popup-avatar" src="{{selectedPlayer.avatarUrl}}"></image>
      <text class="popup-nickname">{{selectedPlayer.nickname}}</text>
      <text class="popup-score">积分：{{selectedPlayer.score}}</text>
      <button class="close-popup-btn" bindtap="hidePlayerInfo">关闭</button>
    </view>
  </view>
  
  <!-- 游戏结束弹窗 -->
  <view class="game-result-popup" wx:if="{{showGameResultPopup}}">
    <view class="game-result-content">
      <view class="game-result-title">游戏结果</view>
      <view class="game-result-message">
        <text>{{gameResultMessage}}</text>
      </view>
      <view class="game-result-scores" wx:if="{{gameResultScores.length > 0}}">
        <view class="score-title">积分变化:</view>
        <view class="score-item" wx:for="{{gameResultScores}}" wx:key="index">
          <text class="score-name">{{item.nickname}}:</text>
          <text class="score-change {{item.change > 0 ? 'positive' : (item.change < 0 ? 'negative' : '')}}">{{item.changeText}}</text>
        </view>
      </view>
      <button class="game-result-btn" bindtap="hideGameResult">确定</button>
    </view>
  </view>
</view>